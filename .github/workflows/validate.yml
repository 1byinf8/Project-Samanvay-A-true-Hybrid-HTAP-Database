name: Validate Git Conventions
on:
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write
  issues: write
    
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Validate branch name
        id: validation
        run: |
          # Set variables
          branch_name="${{ github.head_ref }}"
          validation_failed=false
          error_message=""
          
          # Validate branch name: username-featurename (allowing numbers at start)
          echo "Checking branch name: $branch_name"
          if ! echo "$branch_name" | grep -qE '^[a-z0-9]+[a-z0-9]*-[a-z]+[a-z0-9-]*$'; then
            echo "Invalid branch name: $branch_name"
            echo "Expected format: username-featurename"
            echo "Example: john-userauth or sarah-paymentgateway"
            validation_failed=true
            error_message="**Branch name validation failed**\n\nBranch: \`$branch_name\`\nExpected format: \`username-featurename\`\nExamples: \`john-userauth\`, \`sarah-paymentgateway\`\n\n"
          else
            echo "Branch name valid: $branch_name"
          fi
          
          # Set outputs for next step
          echo "validation_failed=$validation_failed" >> $GITHUB_OUTPUT
          {
            echo "error_message<<EOF"
            echo -e "$error_message"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          # Exit with error if validation failed
          if [ "$validation_failed" = "true" ]; then
            exit 1
          fi

      - name: Comment on PR and close if validation failed
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const rawErrorMessage = process.env.ERROR_MESSAGE || '';
            
            const comment = `## Git Convention Validation Failed
            
            ${rawErrorMessage}
            
            **Please fix the above issue and create a new PR with:**
            - Correct branch name format: \`username-featurename\`
            
            This PR will be closed automatically. Create a new PR once the issue is fixed.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              state: 'closed'
            });
            
            console.log('PR commented and closed due to invalid branch name');
        env:
          ERROR_MESSAGE: ${{ steps.validation.outputs.error_message }}
